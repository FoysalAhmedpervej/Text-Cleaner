<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini Equation Cleaner</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- MathJax -->
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
  body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; padding: 40px; }
  .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  textarea { width: 100%; height: 180px; font-size: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; resize: vertical; }
  .btns { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
  button { background-color: #0078d4; color: white; border: none; border-radius: 6px; padding: 10px 16px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
  button:hover { background-color: #005fa3; }
  #output { background: #fafafa; border-radius: 8px; padding: 20px; margin-top: 25px; white-space: pre-wrap; font-size: 16px; border: 1px solid #ddd; min-height: 150px; }
  .hidden { display: none; }
  
  /* Keep content on single line - no line breaks */
  .no-break { 
    white-space: nowrap !important; 
    display: inline !important;
  }
  
  .no-break * {
    white-space: nowrap !important;
    display: inline !important;
  }
  
  /* MathJax inline fix */
  mjx-container[jax="SVG"][display="false"] { 
    display: inline-block !important; 
    white-space: nowrap !important; 
    vertical-align: middle !important; 
  }
  
  @media print {
    body * { visibility: hidden; }
    #output, #output * { visibility: visible; color: #000; background: #fff; }
    #output { position: absolute; top: 0; left: 0; width: 100%; padding: 40px; font-size: 12pt; line-height: 1.6; }
    .no-break { white-space: nowrap !important; }
  }
</style>
</head>
<body>
<div class="container">
  <h2 class="text-center text-2xl font-bold mb-6">Gemini Equation Cleaner</h2>

  <div id="rawBox">
    <textarea id="rawInput" placeholder="Paste text with equations, e.g., div J + ∂ρ/∂t = 0 or $E = mc^2$"></textarea>
  </div>

  <div class="btns">
    <button id="toggleRawBtn">Toggle Raw Box</button>
    <button id="generateBtn">Generate Clean Text</button>
    <button id="printBtn">Print Cleaned Text</button>
  </div>

  <div id="output" class="mt-6">Cleaned text with equations will appear here...</div>
</div>

<script>
const rawBox = document.getElementById('rawBox');
const toggleRawBtn = document.getElementById('toggleRawBtn');
const generateBtn = document.getElementById('generateBtn');
const printBtn = document.getElementById('printBtn');
const output = document.getElementById('output');
const textarea = document.getElementById('rawInput');

toggleRawBtn.addEventListener('click', () => rawBox.classList.toggle('hidden'));

const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
const API_KEY = "AIzaSyC-X8lrzT3M1mAxvCE43EDmx0WL_nuIF_Q";

// Remove line breaks and extra spaces inside brackets
function cleanBrackets(text) {
  return text.replace(/\(([^)]+)\)/gs, (match, content) => {
    const cleaned = content.replace(/\s+/g, ' ').trim();
    return `(${cleaned})`;
  });
}

// Clean inline equations - handle multi-line equations
function cleanInlineEquations(text) {
  return text.replace(/\$([^$]+)\$/gs, (match, content) => {
    const cleaned = content.replace(/\s+/g, ' ').trim();
    return `$${cleaned}$`;
  });
}

// Preprocess input text - clean before sending to Gemini
function preprocessText(text) {
  text = cleanInlineEquations(text);
  text = cleanBrackets(text);
  text = text.replace(/\n+/g, '\n').trim();
  return text;
}

// Wrap all brackets in no-break spans in the output
function wrapAllBrackets(html) {
  html = html.replace(/\(([^)]+)\)/gs, (match, content) => {
    const cleaned = content.replace(/\s+/g, ' ').trim();
    return `(${cleaned})`;
  });
  
  return html.replace(/\(([^)]+)\)/g, '<span class="no-break">($1)</span>');
}

async function geminiCleanText() {
  let text = textarea.value.trim();
  if (!text) {
    output.innerHTML = "⚠️ Please enter some text.";
    return;
  }
  output.innerHTML = "Processing with Gemini...";
  
  text = preprocessText(text);

  try {
    const payload = {
      contents: [{ parts: [{ text }] }],
      system_instruction: { parts: [{ text: `
        You are a scientific text cleaner.
        - Clean all extra spaces and unwanted characters.
        - Ensure all equations use proper LaTeX delimiters ($ for inline, $$ for display).
        - Keep variables and equations in brackets like (x + y) intact on single lines.
        - Return HTML with <p>, <ul>, <ol>, <br> for lists.
        - Do not add line breaks within equations or bracketed expressions.
        - Preserve the content exactly as given, just format it nicely.
      ` }] }
    };

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    let cleanedHTML = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "⚠️ No output generated.";

    cleanedHTML = cleanedHTML.replace(/```html\n?/g, '').replace(/```\n?/g, '');
    cleanedHTML = wrapAllBrackets(cleanedHTML);

    output.innerHTML = cleanedHTML;
    if (window.MathJax) MathJax.typesetPromise();

  } catch (err) {
    output.innerHTML = "❌ Error: " + err.message;
  }
}

generateBtn.addEventListener('click', geminiCleanText);

printBtn.addEventListener('click', () => {
  if (!output.innerText.trim()) { 
    alert("No content to print!"); 
    return; 
  }
  window.print();
});
</script>
</body>
</html>
